#include <WiFi.h>
#include <WebSocketsServer.h>
#include <ArduinoJson.h>

// ===== CONFIGURAÇÃO DO WIFI =====
const char* ssid = "NOME_DA_REDE";
const char* password = "SENHA_DA_REDE";

// ===== WEBSOCKET =====
WebSocketsServer webSocket = WebSocketsServer(8080);

// ===== SENSOR IR =====
#define SENSOR_PIN 34

// Controle de contagem
int contador = 0;
bool estadoAnterior = HIGH;

void notificarClientes() {
  StaticJsonDocument<200> doc;
  doc["contagem"] = contador;
  
  String jsonString;
  serializeJson(doc, jsonString);

  webSocket.broadcastTXT(jsonString);
}

void handleSensor() {
  int leitura = digitalRead(SENSOR_PIN);

  // LOW significa ativado no sensor IR do Tinkercad
  if (leitura == LOW && estadoAnterior == HIGH) {
    contador++;
    notificarClientes();
    delay(300);
  }

  estadoAnterior = leitura;
}

void webSocketEvent(byte num, WStype_t type, uint8_t * payload, size_t length) {
  if (type == WStype_CONNECTED) {
    Serial.println("Cliente conectado");
    notificarClientes();
  }
}

void setup() {
  Serial.begin(115200);

  pinMode(SENSOR_PIN, INPUT);

  Serial.println("Conectando ao WiFi...");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nWiFi conectado!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  webSocket.loop();
  handleSensor();
}